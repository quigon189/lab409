**Тема:** Установка гостевой ОС Ubuntu на виртуальную машину QEMU/KVM в Debian  
**Цель:** Освоить работу с гипервизором QEMU/KVM, установить гостевую ОС Ubuntu Server с настройкой сетевого моста и управлением через Virt-Manager.  

---

### **Теоретическая часть**  

#### **Виртуализация**  
Виртуализация представляет собой технологию создания изолированных программных сред (виртуальных машин) на единой физической платформе. Это позволяет одновременно запускать несколько операционных систем на одном сервере, обеспечивая эффективное использование ресурсов, изоляцию приложений и упрощение развертывания ИТ-инфраструктуры. В экосистеме Linux наиболее мощным решением для полной виртуализации является связка KVM (Kernel-based Virtual Machine) и QEMU (Quick Emulator), дополненная инструментом управления Virt-Manager.

#### **KVM (Kernel-based Virtual Machine)**

KVM — модуль ядра Linux, превращающий ядро ОС в гипервизор типа 1 (bare-metal). Позволяет создавать виртуальные машины с нативной производительностью.

**Принцип работы:**
- Использует аппаратную виртуализацию CPU (Intel VT-x / AMD-V).
- Каждая ВМ запускается как обычный процесс Linux (виден через `ps aux`).
- Прямой доступ к аппаратным ресурсам: CPU, память, устройства ввода-вывода.

#### **QEMU (Quick Emulator)**

Динамический транслятор, эмулирующий полную аппаратную платформу (CPU, память, периферию). Работает без KVM, но в связке с ним дает ускоренную виртуализацию.

**Функции:**
- **Эмуляция оборудования**: ARM, PowerPC, x86 и др.
- **Виртуализация**: Использует KVM для ускорения.
- **Устройства виртуальных машин**:
    - Диски (форматы QCOW2, RAW)
    - Сетевые карты (virtio-net)
    - Графика (SPICE, VNC)

**Особенности QCOW2:**
- Формат дисков с поддержкой:
    - Снапшотов
    - Сжатия
    - Шифрования
    - Отложенного выделения места

#### **Virt-Manager (Virtual Machine Manager)**

Графический интерфейс для управления KVM/QEMU через библиотеку Libvirt. Аналог VirtualBox для Linux.

**Функционал:**
- Создание/удаление ВМ
- Мониторинг ресурсов (CPU, RAM, сеть)
- Управление дисками и образами ISO
- Настройка виртуальных сетей (NAT, мост, VLAN)
- Работа со снапшотами
- VNC/SPICE-консоль

---

### **Задания**  

#### **1. Установка QEMU/KVM и зависимостей**  
```bash  
sudo apt update  
sudo apt install qemu-kvm libvirt-daemon-system virtinst bridge-utils libguestfs-tools libosinfo-bin virt-manager -y  
```  
- Добавьте пользователя в группы:  
  ```bash  
  sudo usermod -aG kvm,libvirt $USER  
  newgrp libvirt  # Обновить группы без перезагрузки  
  ```  

---

#### **2. Настройка сетевого моста**  
1. Создайте мостовой интерфейс:  
   ```bash  
   sudo nano /etc/network/interfaces.d/bridge  
   ```  
   Добавьте:  
   ```  
   auto br0  
   iface br0 inet dhcp  
       bridge_ports enp2s0  # Замените enp2s0 на ваш интерфейс (ip a)  
       bridge_stp off  
       bridge_fd 0  
   ```  
2. Перезапустите сеть:  
   ```bash  
   sudo systemctl restart networking  
   ```  

---

#### **3. Создание виртуальной машины**  
1. Запустите Virt-Manager (либо воспользуйтесь CLI режимом, см. примечание в конце документа):  
   ```bash  
   virt-manager  
   ```  
2. **Создать новую ВМ** → Локальный установочный медиа (ISO):  
   - **Выбрать образ**: укажите путь к образу ubuntu.  
   - **ОС**: Linux / Ubuntu 22.04 (автоопределение).  
   - **Память**: 1024 МБ, **CPU**: 2 ядра.  
   - **Диск**: 20 ГБ (формат QCOW2).  
   - **Сеть**: Мост br0 → **Готово**.  

---

#### **4. Установка Ubuntu Server**  
1. В окне Virt-Manager запустите ВМ → следуйте интерактивному установщику:  
   - **Язык**: Russian.  
   - **Сеть**: оставьте DHCP (проверьте, что интерфейс выбран).  
   - **Диски**: Use entire disk (авторазметка).  
   - **Профиль**:  
     - Имя: `qemu-<ваша_фамилия>`  
     - Пароль: `P@ssw0rd`  
     - Установите OpenSSH Server.  
   - **Дополнения**: пропустите.  
2. После установки → **Reboot**.  

---

#### **5. Проверка работы**  
1. Войдите в ВМ через консоль Virt-Manager или по SSH:  
   ```bash  
   ssh qemu-user@<IP_ВМ>  
   ```  
2. Выполните:  
   ```bash  
   ip a                      # Проверка IP  
   lsb_release -a            # Версия Ubuntu  
   sudo systemctl status ssh # Работа SSH  
   ```  

---

### **Контрольные вопросы**  
1. Чем отличается QEMU от KVM?  
2. Как добавить постоянное хранилище для ВМ?  
3. Как настроить проброс портов для доступа к веб-серверу в гостевой ОС?  
4. Зачем нужен мостовой режим сети?  

---

**Примечания:**  
- Для текстовой установки (без GUI) используйте `virt-install`:  
  ```bash  
  virt-install \
    --name Ubuntu-VM \
    --ram 1024 \
    --vcpus 2 \
    --disk size=20 \
    --network bridge=br0 \
    --os-variant ubuntu22.04 \
    --graphics spice \
    --cdrom /path/to/ubuntu.iso
  ```  
- При проблемах с сетью проверьте: `sudo virsh net-list --all`.